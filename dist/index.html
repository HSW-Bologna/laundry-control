<!DOCTYPE html>
<html>
<script src="elm.js"></script>

<body>
    <div id="elm-container" style="width: 100%; height: 100%;"></div>
    <script type="module">
        const emit = window.__TAURI__.event.emit;
        const listen = window.__TAURI__.event.listen;
        const invoke = window.__TAURI__.invoke;

        changePage("PageSelection", "italiano")
            .then(_ => invoke("init_tasks"));

        async function changePage(page, language) {
            function removeAllChildNodes(parent) {
                while (parent.firstChild) {
                    parent.removeChild(parent.firstChild);
                }
            }

            if (Elm.Pages[page] == undefined) {
                return;
            }

            var container = document.getElementById("elm-container");
            var appDiv = document.createElement("div");
            removeAllChildNodes(container);
            container.appendChild(appDiv);

            var app = Elm.Pages[page].init({ node: appDiv, flags: language });

            for (const port in app.ports) {
                if (app.ports[port].hasOwnProperty("subscribe")) {
                    app.ports[port].subscribe(function (arg) {
                        console.log("From Elm:", port, arg);

                        var toSend = undefined;
                        if (typeof arg === "string" || arg instanceof String) {
                            // If it's already a string don't stringify it (it adds quotes)
                            toSend = arg;
                        } else {
                            toSend = JSON.stringify(arg);
                        }

                        emit(port, toSend)
                            .then(() => console.log("Event handled by Rust"))
                            .catch(() => console.log("Event discarded by Rust"));
                    });
                } else if (app.ports[port].hasOwnProperty("send")) {
                    console.log("roba", port);
                    await listen(port, (event) => {
                        console.log("To Elm:", port, event);
                        app.ports[port].send(event);
                    });
                }
            }

            app.ports.navigateTo.subscribe(function (message) {
                changePage(message.page, message.language);
            });
        }
    </script>
</body>

</html>